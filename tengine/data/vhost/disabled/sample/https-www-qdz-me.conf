
server {
    listen 80;
    listen 443 ssl http2;
    server_name qdz.me www.qdz.me;
    index index.html index.htm default.html;
    root /app/site/qdz;
    
    add_header "DC" "${hostname}";

    # HTTP to HTTPS
    if ($scheme = 'http'){
        rewrite ^/(.*)$ https://www.qdz.me$uri permanent;
    }
    
    # 根域名301重定向到www
    if ($host = 'qdz.me' ) {
        rewrite ^/(.*)$ $scheme://www.qdz.me$uri permanent;
    }

    # SSL证书设置
    ssl on;
    ssl_certificate     /data/ssl/qdz/qdz.pem;
    ssl_certificate_key /data/ssl/qdz/qdz.key;
    ssl_session_timeout 1d;
    ssl_session_cache   shared:SSL:50m;
    ssl_session_tickets off;

    # Diffiel-Hellman
    ssl_dhparam         /data/ssl/dhparam.pem;

    # SSL模式设置
    ssl_protocols               TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers                 EECDH+CHACHA20:EECDH+CHACHA20-draft:EECDH+AES128:RSA+AES128:EECDH+AES256:RSA+AES256:EECDH+3DES:RSA+3DES:!MD5;
    ssl_prefer_server_ciphers   on;

    # HSTS
    add_header "Strict-Transport-Security" "max-age=31536000";

    # OCSP
    ssl_stapling on;
    ssl_stapling_verify on;
    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;
    ssl_trusted_certificate /data/ssl/root_CA_cert_plus_intermediates;

    location ~ .*\.(gif|jpg|jpeg|png|bmp|swf)$ {
        expires      30d;
    }

    location ~ .*\.(js|css)?$ {
        expires      12h;
    }
}

